// CampkWeb01 Database Schema  
// PostgreSQL with Prisma ORM

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// ============================================
// SITE CONFIGURATION
// ============================================

model SiteConfig {
  id        String   @id @default(cuid())
  key       String   @unique
  value     Json
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([key])
}

// ============================================
// VEHICLES & INVENTORY
// ============================================

model Vehicle {
  id                  String               @id @default(cuid())
  title               String
  price               Int
  listPrice           Int?
  mileage             Int
  fuel                String
  transmission        String
  year                Int
  vrm                 String?              @unique
  body                String
  colour              String
  description         String               @db.Text
  status              VehicleStatus        @default(IN_PREP)
  features            String[]
  images              String[]
  complianceNotes     String?              @db.Text
  complianceProofs    Json?
  complianceHistory   Json?
  views               Int                  @default(0)
  savedCount          Int                  @default(0)
  createdAt           DateTime             @default(now())
  updatedAt           DateTime             @updatedAt
  publishedAt         DateTime?
  soldAt              DateTime?

  leads               Lead[]
  priceHistory        VehiclePriceHistory[]
  viewAnalytics       VehicleView[]
  savedByUsers        SavedVehicle[]

  @@index([status, publishedAt])
  @@index([vrm])
  @@index([createdAt])
}

enum VehicleStatus {
  IN_STOCK
  RESERVED
  IN_PREP
  SOLD
}

model VehiclePriceHistory {
  id         String   @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  price      Int
  reason     String?
  createdAt  DateTime @default(now())
  createdBy  String?

  @@index([vehicleId, createdAt])
}

model VehicleView {
  id         String   @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  referrer   String?
  userAgent  String?
  ipHash     String?
  viewedAt   DateTime @default(now())

  @@index([vehicleId, viewedAt])
  @@index([ipHash])
}

model SavedVehicle {
  id         String   @id @default(cuid())
  vehicleId  String
  vehicle    Vehicle  @relation(fields: [vehicleId], references: [id], onDelete: Cascade)
  sessionId  String
  createdAt  DateTime @default(now())

  @@unique([vehicleId, sessionId])
  @@index([sessionId])
}

// ============================================
// WAREHOUSE & LETTING
// ============================================

model WarehouseUnit {
  id              String              @id @default(cuid())
  name            String              @unique
  sizeSqFt        Int
  availability    UnitAvailability    @default(AVAILABLE)
  pricePerMonth   Int
  features        String[]
  description     String?             @db.Text
  images          String[]
  displayOrder    Int                 @default(0)
  isActive        Boolean             @default(true)
  createdAt       DateTime            @default(now())
  updatedAt       DateTime            @updatedAt

  bookings        WarehouseBooking[]
  availabilityBlocks AvailabilityBlock[]
  tenancies       Tenancy[]

  @@index([availability, isActive])
}

enum UnitAvailability {
  AVAILABLE
  RESERVED
  LET
  IN_PREP
  COMING_SOON
}

model WarehouseBooking {
  id           String        @id @default(cuid())
  unitId       String
  unit         WarehouseUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  leadId       String?       @unique
  lead         Lead?         @relation(fields: [leadId], references: [id])

  name         String
  email        String
  phone        String?
  company      String?
  requestedStartDate DateTime?
  requestedEndDate   DateTime?
  message      String?       @db.Text
  status       BookingStatus @default(PENDING)

  adminNotes   String?       @db.Text
  approvedBy   String?
  approvedAt   DateTime?
  rejectedReason String?

  createdAt    DateTime      @default(now())
  updatedAt    DateTime      @updatedAt

  tenancy      Tenancy?

  @@index([unitId, status])
  @@index([email])
  @@index([createdAt])
}

enum BookingStatus {
  PENDING
  APPROVED
  REJECTED
  CANCELLED
  CONVERTED
}

model Tenancy {
  id              String            @id @default(cuid())
  bookingId       String            @unique
  booking         WarehouseBooking  @relation(fields: [bookingId], references: [id])
  unitId          String
  unit            WarehouseUnit     @relation(fields: [unitId], references: [id], onDelete: Restrict)

  tenantName      String
  tenantEmail     String
  tenantPhone     String?
  tenantCompany   String?

  startDate       DateTime
  endDate         DateTime?
  monthlyRate     Int
  depositAmount   Int
  depositPaid     Boolean           @default(false)
  accessCode      String?

  status          TenancyStatus     @default(ACTIVE)

  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  terminatedAt    DateTime?

  payments        Payment[]
  accessLogs      AccessLog[]

  @@index([unitId, status])
  @@index([tenantEmail])
  @@index([status, endDate])
}

enum TenancyStatus {
  ACTIVE
  NOTICE_GIVEN
  TERMINATED
  EXPIRED
}

model AvailabilityBlock {
  id          String        @id @default(cuid())
  unitId      String
  unit        WarehouseUnit @relation(fields: [unitId], references: [id], onDelete: Cascade)
  startDate   DateTime
  endDate     DateTime
  reason      String
  notes       String?       @db.Text
  createdAt   DateTime      @default(now())
  createdBy   String?

  @@index([unitId, startDate, endDate])
}

model AccessLog {
  id          String    @id @default(cuid())
  tenancyId   String
  tenancy     Tenancy   @relation(fields: [tenancyId], references: [id], onDelete: Cascade)
  accessType  String
  accessedAt  DateTime  @default(now())
  notes       String?

  @@index([tenancyId, accessedAt])
}

// ============================================
// LEADS & CRM
// ============================================

model Lead {
  id          String      @id @default(cuid())
  channel     LeadChannel
  name        String
  email       String
  phone       String?
  company     String?
  message     String?     @db.Text
  vehicleId   String?
  status      LeadStatus  @default(NEW)
  source      String?
  assignedTo  String?

  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  contactedAt DateTime?
  qualifiedAt DateTime?
  convertedAt DateTime?

  vehicle     Vehicle?    @relation(fields: [vehicleId], references: [id], onDelete: SetNull)
  booking     WarehouseBooking?
  notes       LeadNote[]

  @@index([status, createdAt])
  @@index([channel, status])
  @@index([email])
}

enum LeadChannel {
  WAREHOUSE
  VEHICLE
  GENERAL
}

enum LeadStatus {
  NEW
  CONTACTED
  QUALIFIED
  WON
  LOST
  SPAM
}

model LeadNote {
  id        String   @id @default(cuid())
  leadId    String
  lead      Lead     @relation(fields: [leadId], references: [id], onDelete: Cascade)
  note      String   @db.Text
  createdBy String
  createdAt DateTime @default(now())

  @@index([leadId, createdAt])
}

// ============================================
// PAYMENTS & INVOICING
// ============================================

model Payment {
  id               String        @id @default(cuid())
  tenancyId        String?
  tenancy          Tenancy?      @relation(fields: [tenancyId], references: [id])

  amount           Int
  currency         String        @default("GBP")
  status           PaymentStatus @default(PENDING)
  type             PaymentType

  stripePaymentId  String?       @unique
  stripeInvoiceId  String?

  dueDate          DateTime
  paidAt           DateTime?
  description      String?

  createdAt        DateTime      @default(now())
  updatedAt        DateTime      @updatedAt

  @@index([tenancyId, status])
  @@index([dueDate])
  @@index([stripePaymentId])
}

enum PaymentStatus {
  PENDING
  PAID
  FAILED
  REFUNDED
  CANCELLED
}

enum PaymentType {
  RENT
  DEPOSIT
  SERVICE_CHARGE
  LATE_FEE
  OTHER
}

// ============================================
// SERVICES
// ============================================

model Service {
  id          String   @id @default(cuid())
  name        String   @unique
  description String   @db.Text
  priceFrom   Int
  isActive    Boolean  @default(true)
  displayOrder Int     @default(0)
  category    String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isActive, displayOrder])
}

// ============================================
// CONTENT & MEDIA
// ============================================

model Media {
  id            String      @id @default(cuid())
  filename      String
  originalName  String
  mimeType      String
  size          Int
  url           String
  cdnUrl        String?
  cloudinaryId  String?     @unique
  width         Int?
  height        Int?
  altText       String?
  caption       String?
  uploadedBy    String?
  category      MediaCategory @default(OTHER)

  createdAt     DateTime    @default(now())

  @@index([category, createdAt])
  @@index([cloudinaryId])
}

enum MediaCategory {
  VEHICLE
  WAREHOUSE
  HERO
  LOGO
  OTHER
}

model Testimonial {
  id        String   @id @default(cuid())
  name      String
  quote     String   @db.Text
  role      String?
  company   String?
  rating    Int?
  isActive  Boolean  @default(true)
  displayOrder Int   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, displayOrder])
}

model Faq {
  id        String   @id @default(cuid())
  question  String
  answer    String   @db.Text
  category  String?
  isActive  Boolean  @default(true)
  displayOrder Int   @default(0)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([category, isActive, displayOrder])
}

// ============================================
// ADMIN & AUTHENTICATION
// ============================================

model AdminUser {
  id            String   @id @default(cuid())
  email         String   @unique
  passwordHash  String
  name          String
  role          AdminRole @default(ADMIN)
  isActive      Boolean  @default(true)
  lastLoginAt   DateTime?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  sessions      AdminSession[]

  @@index([email])
}

enum AdminRole {
  SUPER_ADMIN
  ADMIN
  EDITOR
  VIEWER
}

model AdminSession {
  id        String    @id @default(cuid())
  userId    String
  user      AdminUser @relation(fields: [userId], references: [id], onDelete: Cascade)
  token     String    @unique
  expiresAt DateTime
  ipAddress String?
  userAgent String?
  createdAt DateTime  @default(now())

  @@index([userId])
  @@index([token])
  @@index([expiresAt])
}

// ============================================
// AUDIT LOG
// ============================================

model AuditLog {
  id         String   @id @default(cuid())
  userId     String?
  action     String
  entity     String
  entityId   String?
  changes    Json?
  ipAddress  String?
  userAgent  String?
  createdAt  DateTime @default(now())

  @@index([entity, entityId])
  @@index([userId, createdAt])
  @@index([createdAt])
}
